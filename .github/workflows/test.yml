name: Test

on:
  push:
  pull_request:
  schedule:
    - cron: '0 0 * * 0' # weekly

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
 
    steps:
      - uses: actions/checkout@v2

      - name: Add host
        run: echo "127.0.0.1 pmg.test" | sudo tee -a /etc/hosts
      - name: Run test
        run:  docker-compose -f docker-compose.yml -f docker-compose-test.yml run --rm web nosetests --with-coverage tests
      - name: Setup Dev Database
        run: docker-compose run --rm web python setup_dev_database.py
      - name: Stamp Head
        run: docker-compose run --rm web python app.py db stamp head
      - name: Reindex All
        run: docker-compose run --rm web python bin/search.py --reindex all
      - name: Docker compose up
        run: docker-compose up -d
      - name: Wait for app
        run: bin/wait-for-app.sh
      - name: Test content
        run: curl -f http://pmg.test:5000 | grep "Featured Content"
      # Run codecov passing appropriate codecov.io CI environment variables to container
      - name: codecov
        run: docker-compose run --rm `bash <(curl -s https://codecov.io/env)` web codecov
